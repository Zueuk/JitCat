cmake_minimum_required(VERSION 3.5)
project(JitCat)

option(FORCE32 "Force a 32bit compile on 64bit" OFF)

if (NOT CMAKE_BUILD_TYPE)
 set(CMAKE_BUILD_TYPE "Release")
endif ()


if(FORCE32)
    set(CMAKE_C_FLAGS "-m32")
    set(CMAKE_CXX_FLAGS "-m32 -fpermissive")
endif()

if(CMAKE_SIZEOF_VOID_P MATCHES "8" AND NOT(FORCE32))
	set(JITCAT_BITNESS "64")
else()
	set(JITCAT_BITNESS "32")
endif()

include_directories(
    ../../include/jitcat
)

file(GLOB JITCAT_SOURCE RELATIVE ${CMAKE_CURRENT_SOURCE_DIR}
    ../../include/jitcat/*.h
    ../../src/jitcat/*.cpp
)

add_library(JitCat STATIC ${JITCAT_SOURCE})

set_target_properties(JitCat
    PROPERTIES
    COMPILE_FLAGS "-std=c++17 -Wno-write-strings -Wno-switch -Wno-unused-function -fPIC -fno-rtti"
    LINK_FLAGS_RELEASE "-Wl,-s,-x"
)

set(LLVM_INCLUDES "" CACHE PATH "LLVM include path.")
set(LLVM_BUILD_INCLUDES "" CACHE PATH "LLVM include path for the includes that are generated by the LLVM build process.")
set(LLVM_LIBS "" CACHE PATH "LLVM libraries path.")
link_directories(${LLVM_LIBS})
include_directories(${LLVM_INCLUDES})
include_directories(${LLVM_BUILD_INCLUDES})
link_libraries(
	LLVMX86Disassembler
	LLVMX86CodeGen
	LLVMX86AsmParser
	LLVMX86Desc
	LLVMX86Info
	LLVMX86AsmPrinter
	LLVMX86Utils
	LLVMSelectionDAG
	LLVMOrcJIT
	LLVMMCDisassembler
	LLVMGlobalISel
	LLVMExecutionEngine
	LLVMRuntimeDyld
	LLVMAsmPrinter
	LLVMCodeGen
	LLVMScalarOpts
	LLVMInstCombine
	LLVMBitWriter
	LLVMAggressiveInstCombine
	LLVMTransformUtils
	LLVMTarget
	LLVMAnalysis
	LLVMProfileData
	LLVMObject
	LLVMMCParser
	LLVMMC
	LLVMDebugInfoCodeView
	LLVMDebugInfoMSF
	LLVMBitReader
	LLVMCore
	LLVMBinaryFormat
	LLVMSupport
	LLVMDemangle
	z
	rt
	dl
	tinfo
	pthread
	m
	xml2
)

add_subdirectory(JitCatTest)
add_subdirectory(JitCatUnitTests)
add_subdirectory(JitCatValidator)
add_subdirectory(JitCatValidatorTool)

install(TARGETS ${PROJECT_NAME}
		RUNTIME DESTINATION ${CMAKE_SOURCE_DIR}/../../bin/${CMAKE_SYSTEM_NAME}${JITCAT_BITNESS}/${CMAKE_BUILD_TYPE}
		LIBRARY DESTINATION ${CMAKE_SOURCE_DIR}/../../lib/${CMAKE_SYSTEM_NAME}${JITCAT_BITNESS}/${CMAKE_BUILD_TYPE}
		ARCHIVE DESTINATION ${CMAKE_SOURCE_DIR}/../../lib/${CMAKE_SYSTEM_NAME}${JITCAT_BITNESS}/${CMAKE_BUILD_TYPE})
		
		
